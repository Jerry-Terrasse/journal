## Journal-2025

### 1.8

#### uv安装flash-attn

由于`flash-attn`包很多时候需要在安装时编译适用于本机的算子，官方推荐的安装方式是`pip install flash-attn --no-build-isolation`。`--no-build-isolation`使得构建时不采用隔离环境，而是使用pip所在环境（这是由于编译算子的过程依赖于`torch`等包）。

uv官方支持了`--no-build-isolation`选项，但`uv pip install flash-attn --no-build-isolation`时会报错`ModuleNotFoundError: No module named 'torch'`。这是由于虽然不采用隔离环境了，但构建时仍是使用`uv pip`所在环境，也就是系统级环境，这个环境中没有安装`torch`等包。

此时一种粗暴的解决方案是在系统级环境中安装构建依赖，但这样会导致系统级环境污染，并且为不同版本环境编译`flash-attn`时还得手动切换系统级`torch`版本，不是一个合理的解决方案。

**解决方案**：我们可以在当前环境中额外安装一个`uv`，通过环境内的`uv`调用`uv pip install flash-attn --no-build-isolation`就可以成功使用当前环境来编译算子，保证了`flash-attn`的构建和运行环境100%一致。

#### 切换CUDA版本

首选使用`update-alternatives`，如果不能使用，则可以通过指定环境变量的方式：

```shell
cuda_path="/usr/local/cuda-11.7" # or other

export CUDA_HOME="${cuda_path}"
export CUDA_ROOT="${cuda_path}"
export LD_LIBRARY_PATH="${cuda_path}/lib64:${cuda_path}/lib:${LD_LIBRARY_PATH}"
export PATH="${cuda_path}/bin:${PATH}"
```

#### uv安装PyTorch最佳实践

1. 在系统中安装所需CUDA版本

2. 根据PyTorch和CUDA版本需求，在[PyTorch官网](https://pytorch.org/get-started/locally/)确定要使用的index

3. 在`pyproject.toml`中添加相应源，并指定`explicit = true`使得仅`torch`相关包使用该源。
   例如：

   ```toml
   [tool.uv.sources]
   torch = [{ index = "pytorch-cu121" }]
   torchvision = [{ index = "pytorch-cu121" }]
   
   [[tool.uv.index]]
   url = "https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple"
   default = true
   
   [[tool.uv.index]]
   name = "pytorch-cu121"
   url = "https://download.pytorch.org/whl/cu121"
   explicit = true
   ```

4. 执行`uv sync`同步环境

[ref](https://docs.astral.sh/uv/guides/integration/pytorch/)

### 1.7

#### git打包文件

git可以将工作区打包为压缩包，只包含被跟踪的文件

```shell
git archive --output "./output.tar.gz" master # 文件类型通过--output自动推断
```

#### 对Gradio应用进行反向代理

反代gradio应用时（例如`example.com/gradio-demo -> localhost:7860`），由于gradio无法感知到外部url路径，会给出错误的资源url，可以通过设置`GRADIO_ROOT_PATH`环境变量解决。[ref](https://www.gradio.app/guides/running-gradio-on-your-web-server-with-nginx)

```nginx
server {
    listen 80;
    server_name example.com www.example.com;  # Change this to your domain name

    location /gradio-demo/ {  # Change this if you'd like to server your Gradio app on a different path
        proxy_pass http://127.0.0.1:7860/; # Change this if your Gradio app will be running on a different port
        proxy_buffering off;
        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 1.6

#### Shell在管道中间复制一份到错误流

```shell
command1 | command2 # original
command1 | tee /dev/stderr | command2 # for debug
```

### 1.1

$\text{The Best Year Ever!}$
