## Journal-2024

record my journey in CS, gain from history, sometimes scandal.

### 9.15

#### shell获取绝对路径

```shell
realpath <target>
```

### 9.12

#### ping指定包长

```shell
ping <host> -s <size>
```

### 9.8

#### SSH无法连通时快速失败

设置ConnectTimeout选项

```shell
ssh <host> -o ConnectTimeout=1 # 1秒
```

#### 便捷管理远端clash-core

```shell
# 在本机启动yacd
docker run -p <port>:80 -d --name yacd --rm ghcr.io/haishanh/yacd:master
# 将远程主机上clash-core的external-controller端口转发到本地
ssh -L <ctrl_port>:127.0.0.1:<ctrl_port> dasc_llm -vNT
```

随后在浏览器中访问`localhost:<port>`进入yacd，并填写API Base URL为`http://localhost:<ctrl_port>`。

### 9.6

#### wget断点续传

`wget ... -c`

### 9.5

#### 查找字体规范名称

```shell
fc-list
# eg. /usr/share/fonts/noto/NotoSansMono-Regular.ttf: Noto Sans Mono:style=Regular
# ==> Noto Sans Mono:style=Regular
```

### 9.3

#### 设置窗口透明度

```shell
xprop -id <window_id> -f _NET_WM_WINDOW_OPACITY 32c -set _NET_WM_WINDOW_OPACITY <opacity>
```

其中`window_id`可以通过`wmctrl -l`获得，`opacity`为整数，`0`表示不透明，`0xffffffff`表示完全透明。

### 8.30

#### GPG签名git commit

[source](https://blog.puckwang.com/posts/2019/sign_git_commit_with_gpg/)

```shell
gpg --list-secret-keys # 列出密钥

gpg --full-generate-key # 生成密钥（交互式）

gpg --armor --export <Fingerprint> # 生成公钥
# 在托管平台添加公钥

git config --global user.signingkey <Fingerprint> # 配置签名公钥
git commit -S -m ... # 提交时签名
git config --global commit.gpgsign true # 提交时默认签名
```

#### ssh给AUR投票

```shell
ssh aur@aur.archlinux.org vote package_name
```

### 8.28

#### LiteLoaderQQNT在QQ更新后失效

是因为启动代码被覆盖，重新安装即可

```shell
yay -S liteloader-qqnt-bin
# :: Running post-transaction hooks...
# (1/1) Patch QQ for LiteLoaderQQNT
```

#### 跨平台久坐提醒工具

[Stretchly](https://github.com/hovancik/stretchly)

### 8.26

#### 配置油猴脚本自动更新

在脚本头部新增`@updateURL`和`@downloadURL`字段，前者提供元信息用于获取版本号，使得油猴插件可以判断脚本是否更新，后者提供脚本完整代码。

（注意链接最后的脚本名是可以随便写的，不影响返回内容 [source](https://greasyfork.org/en/discussions/greasyfork/247229-changes-to-the-downloadurl-and-updateurl)）

```js
// @downloadURL  https://update.greasyfork.org/scripts/<script_id>/<script_name>.user.js
// @updateURL    https://update.greasyfork.org/scripts/<script_id>/<script_name>.user.js
```

### 8.22

#### ImageMagick压缩图片

```shell
magick -quality 75 <from.png> <to.jpg> # 75 out of 100
```

### 8.20

#### yay禁用check

```shell
yay -S <pkg> --mflags "--nocheck"
```

### 8.8

#### oh-my-zsh Cheet Sheet

[source](https://blog.praveen.science/oh-my-zsh-cheat-sheet/)

#### oh-my-zsh快捷cd

```shell
d # display the dir stack
1~9 # cd to the corresponding dir
```

### 8.7

#### fcitx环境变量最佳配置

[source](https://wiki.archlinuxcn.org/wiki/Fcitx5#X11)

`/etc/environment`:

```
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
SDL_IM_MODULE=fcitx
GLFW_IM_MODULE=ibus
```

### 8.2

#### 禁用某些cpu核

```shell
cpupower-gui offline [LIST OF CPUS] # eg. 0,1,2,11,13
```

### 8.1

#### 安卓虚拟位置

[solution](https://github.com/Lerist/FakeLocation)

有没有ROOT都可以，有ROOT支持基站模拟

#### scp限速

```sell
scp -l <limit> ... # 参数单位为Kb/s，所以注意乘以8
```

### 7.29

#### ext4分区在线扩容

[source](https://serverfault.com/questions/509468/how-to-extend-an-ext4-partition-and-filesystem)

### 7.28

#### 检索手册

`apropos <key-word>`

#### web server防止.git文件夹暴露

```nginx
location ~ /\.git { # 需要放在其他location块之前
    deny all;
}
```

### 7.26

#### 测试ssh连接质量

```shell
yay -S sshping
sshping <host>
```

### 7.22

#### ssh连接复用

有时服务器只允许密码登录，但重复输入密码比较麻烦，可以配置连接复用实现短时间内只用重新输入一次密码。

`~/.ssh/config`:

```
Host <host>
    <...>
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 600 # keep 600s
```

### 7.20

#### md5批量校验

```shell
md5sum * > checklist.chk
md5sum -c checklist.chk
```

### 7.19

#### 快速传文件到服务器

如果本机到服务器的连接带宽受限，但本机和服务器都有较高的公网带宽，可以借助中转站快速传文件。例如[SwissTransfer](https://www.swisstransfer.com) [CowTransfer](https://cowtransfer.com)

下载链接无法直接wget（403 forbidden），可以先在本机浏览器找到任意一个常规请求，拷贝对应的CURL命令，然后将下载链接替换进去。

```shell
curl --output a.zip <raw-download-link> -H ... -H ...
```

### 7.15

#### 无root权限使用PyEnv

由于pyenv有一些构建依赖，无root时`pyenv install`会遭遇`Build Fail`。

解决方案：使用conda进行local install，创建虚拟环境给pyenv用。

```shell
conda create -n py310 python=3.10
conda activate py310

cd .pyenv/versions
python -m venv py310

pyenv virtualenv py310 new_env
pyenv shell new_env
# new_env is like a normal pyenv virtual environment
# but py310 can not be used directly
```

#### 无root权限安装zsh

[solution](https://gist.github.com/ZhaofengWu/f345652e994e3b68c309352a7610460f)

```shell
export PREFIX=$HOME/.local

# OPTIONAL: zsh will not install without ncurses. IF your machine doesn't have ncurses, you need to install it first.
export CXXFLAGS=" -fPIC" CFLAGS=" -fPIC" CPPFLAGS="-I${PREFIX}/include" LDFLAGS="-L${PREFIX}/lib"
wget https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.2.tar.gz
tar -xzvf ncurses-6.2.tar.gz
cd ncurses-6.2
./configure --prefix=$PREFIX --enable-shared
make
make install
cd .. # && rm ncurses-6.2.tar.gz && rm -r ncurses-6.2

# install zsh itself
wget -O zsh.tar.xz https://sourceforge.net/projects/zsh/files/latest/download
mkdir zsh && unxz zsh.tar.xz && tar -xvf zsh.tar -C zsh --strip-components 1
cd zsh
./configure --prefix=$PREFIX
make
make install
cd .. # && rm zsh.tar && rm -r zsh
echo -e "export SHELL=\$HOME/.local/bin/zsh\nexec \$SHELL -l" >> ~/.bash_profile # or chsh

# OPTIONAL: install oh-my-zsh
sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"
```

### 6.18

#### 更新PyEnv

```shell
pyenv update
```

### 6.12

#### sudo常用选项

```shell
sudo -u user # 指定用户
sudo -E # 保留环境变量
```

### 6.10

#### 端口扫描

```shell
nmap -sT <target> # TCP connect扫描
sudo nmap -sS <target> # SYN扫描
```

### 6.8

#### 打断pacman安装导致系统损坏的恢复方法

`pacman -Syu`过程中卡死，只好强制重启，重启后出现Kernel Panic。经排查，发现是安装更新时首先会删除被更新的文件全部内容（变为空文件），然后再统一写入新文件内容，此时打断导致大量关键文件缺失（如libc.so）。

在这种情况下广为流传的 `chroot`+重新安装 方案不能解决问题，执行`chroot`时会出现`chroot: failed to run command '/bin/bash': Input/output error`。但是可以通过外部`pacman`直接向挂载的guest根目录中安装。

solution:

```shell
# Boot into an installation media
sudo mount /dev/nvme0n1p8 /mnt
sudo pacman -Syy
sudo pacman --root=/mnt --cachedir=/mnt/var/cache/pacman/pkg -S $(pacman --root=/mnt -Qnq) # re-install all installed packages
```

期间可能会遇到GPG签名验证不通过的情况，可以通过安装`manjaro-keyring`或手动导入密钥解决。

由于不是在当前系统中执行安装，很多`post-hook`之类的会执行失败，但是没有关系，不影响修复文件。安装完毕后重启发现可以进入系统，但是一些系统组件没有正常工作（例如由`dkms`管理的显卡驱动）。此时需要重新再安装一次，以便正确执行`post-hook`。

```shell
sudo pacman -Syy
sudo pacman -S $(pacman -Qnq)
```

### 6.7

#### Windows OpenSSH 更改登录SHELL为PowerShell

编辑`C:\ProgramData\ssh\sshd_config`，在末尾添加：

```
Match User <your_username>
   ForceCommand powershell.exe -NoLogo -NoProfile
```

重启sshd服务：

```powershell
Restart-Service sshd
```

### 5.23

#### gdb打印ip地址

```c
(gdb) p (char*)inet_ntoa(*(uint32_t*)ip_hdr->dst_ip)
```

#### ssh port forwarding转发HTTPS服务

```shell
ssh -vNT -L 4433:example.com:443 <host>
```

修改`/etc/hosts`：

```
127.0.0.1 example.com
```

于是浏览器可以访问https://example.com:4433

#### pyenv使用系统包管理器安装的包

起因：`graph-tool`只能使用conda或包管理器系统级安装，pip无法安装

[solution](https://stackoverflow.com/questions/55600132/installing-local-packages-with-python-virtualenv-system-site-packages)

```shell
pyenv virtualenv system venv # use system-wide python version
vim ~/.pyenv/versions/cc_system/cc_system/pyvenv.cfg # EDIT: include-system-site-packages = true
```

### 5.19

#### Linux和Windows之间远程同步文件方案

1. 在Windows端配置`Openssh Server`
2. 使用`sshfs`将Windows端的目标文件夹挂载到Linux端
3. 使用基于`rsync`的常规文件同步工作流，忽略文件系统导致的问题`rsync --no-owner --no-perms --no-group ...`

#### winget常用命令

```powershell
winget source remove winget
winget source add winget https://mirrors.ustc.edu.cn/winget-source

winget search 7zip
winget show --id 7zip.7zip
winget install --id 7zip.7zip
winget upgrade --id 7zip.7zip
winget uninstall --id 7zip.7zip
```

#### Windows配置ssh server

先启用`Openssh Server`应用组件及服务

如果是管理员用户，公钥不能放在`%HOME%`：[solution](https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_keymanagement#administrative-user)

### 5.16

#### 快速清理旧文件

```shell
# only work in zsh
mv path/to/*(.m+30) target/path # move all files with mtime before 30 days
mv path/to/*(/m+30) target/path # for folders
```

### 5.11

#### convert常见用法

```shell
convert path/to/input_image.jpg path/to/output_image.png
convert path/to/input_image.png -resize 640x480 path/to/output_image.png
convert path/to/image1.png path/to/image2.png ... -delay 10 path/to/animation.gif # delay 100ms
```

### 5.10

#### 配置多网卡后无法上网

```shell
ip route # 查看默认网关
ip route del default via 192.168.1.100 # 删除不正确的网关
```

### 5.7

#### 解除Firefox侧边栏宽度限制

[solution](https://superuser.com/questions/1276800/customize-the-maximum-width-of-the-firefox-sidebar)

### 5.6

#### 网站自定义快捷键

使用油猴插入脚本

```javascript
window.addEventListener("keydown", function(e){
    if(e.altKey && e.key == "z"){
        document.getElementsByClassName("icon-shape-rect")[0].click();
    }
});
```

### 4.30

#### 调试Makefile

打印跟踪信息：`make --trace`

打印全部调试信息：`make --debug=a`

### 4.2

#### 多线程加速apt

[apt-fast](https://github.com/ilikenwf/apt-fast)

#### 多核加速pip build wheel

```shell
MAKEFLAGS="-j`nproc`" pip install ...
```

### 3.27

#### 普通用户自定义安装CUDA Toolkit

当需要的CUDA版本和全局安装的不一致，又不想影响全局环境

```shell
wget https://developer.download.nvidia.com/compute/cuda/12.4.0/local_installers/cuda_12.4.0_550.54.14_linux.run # 从 https://developer.nvidia.com/cuda-downloads 选择合适版本的runfile
export TARGET_PATH=<custom installation path>
bash cuda_12.4.0_550.54.14_linux.run --toolkit --toolkitpath=$TARGET_PATH

# 编辑 .zshrc
alias cuda12_enable="export LD_LIBRARY_PATH=$TARGET_PATH/lib64:$LD_LIBRARY_PATH; export PATH=$TARGET_PATH/bin:$PATH"
```

[source](https://github.com/pyg-team/pytorch_geometric/issues/392#issuecomment-503335625)

#### pip install自定义临时缓存

当`/tmp`空间不足时，pip无法进行安装，自定义缓存路径即可

```shell
TMPDIR=/path/to/tmp pip install --cache-dir=$TMPDIR ...
```

### 3.26

#### 允许用户设置低nice

`/etc/security/limits.conf`

```
username            -       nice            -20
```

需要重新登录用户，`ulimit -a`检查是否设置成功

### 3.1

#### docker清理无用容器

```shell
docker rm -v $(docker ps --filter status=exited -q)
```

### 2.24

#### ipynb导出到py文件

```shell
pip install nbconvert
jupyter nbconvert --to script <xxx.ipynb>
```

### 2.20

#### ipynb跳过单元格

```python
%%script true

<code to skip>
```

### 2.18

#### Python类型注解允许隐式Optional

`pyrightconfig.json`:

```json
{
    "strictParameterNoneValue": false
}
```

### 2.17

#### VMWare和Linux Memory Compaction的冲突问题

Linux使用Transparent HugePage技术来提高内存效率，需要内核线程`kcompactd`在后台进行内存整理。但这一过程会导致虚拟机周期性卡顿，关闭此技术即可。

解决方法（root下执行，重启后失效）：

```shell
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag
```

[source](https://gist.github.com/2E0PGS/2560d054819843d1e6da76ae57378989)

### 2.5

#### 节省yay压缩软件包时间

修改`~/.makepkg.conf`中的`PKGEXT=.pkg.tar.xz`为`PKGEXT=.pkg.tar`

因为使用yay打包后一般是立即安装，而不是发布，此设置可以节省xz压缩、解压的过程

[source](https://bbs.archlinux.org/viewtopic.php?id=167241)

### 1.30

#### docker容器访问宿主机上的服务

##### 使用host.docker.internal

```shell
docker ... --add-host=host.docker.internal:host-gateway
```

```yaml
# docker-compose.yml
services:
  xxx:
  
  	...
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

#### 直接使用宿主机网络

（可能不安全）

```shell
docker ... --net=host
```

```yaml
# docker-compose.yml
services:
  xxx:
  
  	...
    
    network_mode: host
```

### 1.26

#### 简单方便的段错误追踪手段libSegFault.so

libSegFault.so由glibc提供

```shell
LD_PRELOAD=/path/to/libSegFault.so ./the_program
```

### 1.23

#### rm避免歧义

当文件/文件夹以`-`开头时

```shell
rm -rf -- -foo
```

#### 非scp远程拷贝

```shell
ssh dd if=xxx | dd of=xxx
```

### 1.6

#### 批量查找

```shell
find ... | xargs cat | grep xxx
```

### 1.3

#### rsync同步文件夹

```shell
rsync -av --progress sourcefolder /destinationfolder --exclude thefoldertoexclude
```

`-n`: dry run

`--exclude`: 相对于sourcefolder， 可重复多次

#### 命令行启动热点

最新一次滚包之后`wihotspot-gui`不能使用了，看起来像是gtk更新导致不兼容。但是`create_ap`是能正常使用的

```shell
sudo create_ap wlo1 wlo1 '<ssid>' '<passphrase>' --freq-band 2.4
```

### 1.1

$\text{A Fresh Start !}$